<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storopack - Assistente T√©cnico</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#e8edf2 100%);color:#333;min-height:100vh}

        /* HEADER MODERNO */
        .header{background:#fff;color:#0056a3;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 12px rgba(0,0,0,.08);position:sticky;top:0;z-index:100;border-bottom:3px solid #0056a3}
        .header-logo{display:flex;align-items:center;gap:12px}
        .header-logo img{height:32px;object-fit:contain}
        .header h1{font-size:1em;font-weight:600;color:#0056a3}
        .header h1 span{font-size:.75em;opacity:.7;display:block;font-weight:400;margin-top:2px}
        .header-btns{display:flex;gap:6px}
        .hdr-btn{background:#f0f4f8;border:none;color:#0056a3;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:.85em;transition:all .2s;display:none;font-weight:500}
        .hdr-btn:hover{background:#e1e8f0}
        .hdr-btn.always{display:inline-block}

        .container{max-width:900px;margin:0 auto;padding:16px 16px 80px}

        /* WELCOME SECTION */
        .welcome{text-align:center;padding:28px 0 20px;background:#fff;border-radius:16px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
        .welcome h2{font-size:1.5em;color:#0056a3;margin-bottom:8px;font-weight:600}
        .welcome p{color:#666;font-size:.95em;line-height:1.5}

        /* MODAL DE REGISTRO */
        .registro-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:300;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
        .registro-modal.active{display:flex}
        .registro-content{background:#fff;border-radius:16px;padding:32px;max-width:440px;width:90%;box-shadow:0 12px 48px rgba(0,0,0,.3)}
        .registro-content h3{color:#0056a3;margin-bottom:8px;font-size:1.4em;font-weight:600;text-align:center}
        .registro-content p{color:#666;font-size:.9em;margin-bottom:20px;text-align:center;line-height:1.5}
        .registro-content label{display:block;color:#333;font-size:.9em;font-weight:500;margin-bottom:6px;margin-top:14px}
        .registro-content input{width:100%;padding:12px 14px;border:2px solid #e8edf2;border-radius:10px;font-size:.95em;outline:none;transition:border-color .2s}
        .registro-content input:focus{border-color:#0056a3}
        .registro-content .hint{font-size:.8em;color:#999;margin-top:4px}
        .registro-content button{background:linear-gradient(135deg,#0056a3,#0078d4);color:#fff;border:none;padding:12px 24px;border-radius:10px;cursor:pointer;font-size:1em;font-weight:600;width:100%;margin-top:20px;transition:transform .2s}
        .registro-content button:hover{transform:translateY(-2px)}
        .registro-content .erro{color:#dc3545;font-size:.85em;margin-top:8px;display:none}

        /* CATEGORIAS - DESIGN MODERNO */
        .categories{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-top:20px}
        .cat-card{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.08);cursor:pointer;transition:all .3s ease;border:2px solid transparent;position:relative}
        .cat-card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,86,163,.15);border-color:#0056a3}
        .cat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#0056a3,#0078d4);opacity:0;transition:opacity .3s}
        .cat-card:hover::before{opacity:1}
        .cat-card img{width:100%;height:140px;object-fit:cover;background:#f8fafc}
        .cat-card-body{padding:14px;text-align:center}
        .cat-card-body h3{font-size:1.05em;color:#0056a3;margin-bottom:4px;font-weight:600}
        .cat-card-body p{font-size:.8em;color:#999}

        /* SUBCATEGORIAS - CLEAN DESIGN */
        .subcats{display:none;animation:fadeIn .3s}
        .subcats.active{display:block}
        .sub-hdr{margin-bottom:16px;padding:16px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
        .sub-hdr h3{font-size:1.2em;color:#0056a3;font-weight:600}
        .sub-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px}
        .sub-card{background:#fff;border-radius:14px;padding:18px 14px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,.06);cursor:pointer;transition:all .3s;border:2px solid transparent;position:relative}
        .sub-card:hover{transform:translateY(-3px);border-color:#0056a3;box-shadow:0 6px 16px rgba(0,86,163,.12)}
        .sub-card img{width:100%;height:80px;object-fit:contain;margin-bottom:10px;border-radius:8px}
        .sub-card .ico{font-size:2em;margin-bottom:8px;color:#0056a3}
        .sub-card h4{font-size:.95em;color:#333;font-weight:600;margin-bottom:4px}
        .sub-card p{font-size:.75em;color:#aaa}

        /* CHAT MODERNO E CLEAN */
        .chat-box{display:none;flex-direction:column;height:calc(100vh - 80px);max-height:calc(100vh - 80px)}
        .chat-box.active{display:flex}
        .chat-info{background:linear-gradient(135deg,#0056a3,#0078d4);border-radius:12px;padding:12px 16px;margin-bottom:12px;font-size:.9em;color:#fff;font-weight:500;box-shadow:0 2px 8px rgba(0,86,163,.2);text-align:center}
        .chat-msgs{flex:1;overflow-y:auto;padding:12px 0;display:flex;flex-direction:column;gap:12px}
        .msg{max-width:82%;padding:12px 16px;border-radius:16px;font-size:.92em;line-height:1.6;word-wrap:break-word;white-space:pre-wrap;animation:slideIn .3s;box-shadow:0 2px 6px rgba(0,0,0,.06)}
        .msg.bot{align-self:flex-start;background:#fff;border:1px solid #e8edf2;border-bottom-left-radius:4px;color:#333}
        .msg.user{align-self:flex-end;background:linear-gradient(135deg,#0056a3,#0078d4);color:#fff;border-bottom-right-radius:4px}
        .msg .tm{font-size:.7em;opacity:.6;margin-top:6px;display:block}
        .typing{display:none;align-self:flex-start;padding:12px 18px;background:#fff;border-radius:16px;border:1px solid #e8edf2;color:#999;font-size:.88em;box-shadow:0 2px 6px rgba(0,0,0,.06)}
        .typing.active{display:block}
        .typing::after{content:'...';animation:dots 1.5s infinite}

        /* INPUT MODERNO */
        .chat-input{display:flex;gap:8px;padding:12px 0 6px;border-top:2px solid #e8edf2;align-items:flex-end;background:#fff;border-radius:12px 12px 0 0;padding:12px}
        .chat-input textarea{flex:1;padding:12px 14px;border:2px solid #e8edf2;border-radius:12px;font-size:.93em;resize:none;min-height:44px;max-height:100px;font-family:inherit;outline:none;transition:border-color .2s}
        .chat-input textarea:focus{border-color:#0056a3}
        .chat-input button{border:none;border-radius:12px;padding:12px 18px;cursor:pointer;font-size:.95em;min-height:44px;transition:all .2s;font-weight:500}
        .btn-send{background:linear-gradient(135deg,#0056a3,#0078d4);color:#fff;box-shadow:0 2px 8px rgba(0,86,163,.2)}
        .btn-send:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,86,163,.3)}
        .btn-send:disabled{background:#a0bdd9;cursor:not-allowed;transform:none}
        .btn-att{background:#f0f4f8;color:#0056a3}
        .btn-att:hover{background:#e1e8f0}

        /* FEEDBACK BAR */
        .fb-bar{display:none;background:#fff8e6;border:2px solid #ffc107;border-radius:12px;padding:14px;margin-top:10px;text-align:center;box-shadow:0 2px 8px rgba(255,193,7,.15)}
        .fb-bar.active{display:block}
        .fb-bar p{font-size:.9em;color:#666;margin-bottom:10px;font-weight:500}
        .fb-bar .btns{display:flex;gap:10px;justify-content:center}
        .fb-bar .b{padding:9px 20px;border-radius:10px;border:none;cursor:pointer;font-size:.9em;font-weight:600;color:#fff;transition:transform .2s}
        .fb-bar .b:hover{transform:scale(1.05)}
        .b-ok{background:#28a745}
        .b-no{background:#dc3545}

        /* PE√áAS INFO */
        .pecas-info{background:#fff;border-radius:16px;padding:32px;text-align:center;box-shadow:0 4px 16px rgba(0,0,0,.08);margin-top:20px;display:none}
        .pecas-info img{width:100%;max-width:400px;height:250px;object-fit:cover;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
        .pecas-info h3{color:#0056a3;margin:12px 0;font-size:1.3em;font-weight:600}
        .pecas-info p{color:#666;line-height:1.7;font-size:.95em}

        /* MODAL GPS */
        .overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
        .overlay.active{display:flex}
        .modal{background:#fff;border-radius:16px;padding:32px;max-width:420px;width:90%;text-align:center;box-shadow:0 12px 48px rgba(0,0,0,.3);animation:modalSlide .3s}
        .modal h3{color:#0056a3;margin-bottom:12px;font-size:1.3em;font-weight:600}
        .modal p{color:#666;font-size:.92em;margin-bottom:18px;line-height:1.6}
        .modal .mg{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
        .modal .btn{padding:10px 24px;border-radius:10px;border:none;cursor:pointer;font-size:.95em;font-weight:600;transition:transform .2s}
        .modal .btn:hover{transform:scale(1.05)}
        .modal .bp{background:linear-gradient(135deg,#0056a3,#0078d4);color:#fff}
        .modal .bs{background:#f0f4f8;color:#0056a3}
        @keyframes modalSlide{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}

        /* MODAL DE V√çDEO */
        .video-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.95);z-index:300;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(8px)}
        .video-modal.active{display:flex}
        .video-container{background:#000;border-radius:16px;overflow:hidden;max-width:900px;width:100%;max-height:90vh;position:relative;box-shadow:0 12px 60px rgba(0,0,0,.6)}
        .video-header{background:linear-gradient(135deg,#0056a3,#0078d4);color:#fff;padding:14px 22px;display:flex;justify-content:space-between;align-items:center}
        .video-header h3{font-size:1.15em;margin:0;font-weight:600}
        .video-close{background:rgba(255,255,255,.2);border:none;color:#fff;width:36px;height:36px;border-radius:8px;cursor:pointer;font-size:1.4em;line-height:1;transition:all .2s}
        .video-close:hover{background:rgba(255,255,255,.35);transform:scale(1.1)}
        .video-wrapper{position:relative;width:100%;padding-top:56.25%;background:#000}
        .video-wrapper video{position:absolute;top:0;left:0;width:100%;height:100%;outline:none}
        .video-error{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;text-align:center;padding:20px}
        .video-error p{font-size:1.1em;margin-bottom:10px}

        /* TOAST */
        .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 24px;border-radius:12px;font-size:.9em;z-index:300;display:none;box-shadow:0 4px 16px rgba(0,0,0,.3);font-weight:500}
        .toast.active{display:block;animation:slideUp .3s}

        /* ANIMA√á√ïES */
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        @keyframes slideUp{from{opacity:0;transform:translate(-50%,10px)}to{opacity:1;transform:translate(-50%,0)}}
        @keyframes dots{0%,20%{content:''}40%{content:'.'}60%{content:'..'}80%,100%{content:'...'}}

        /* MOBILE RESPONSIVO */
        @media(max-width:600px){
            .container{padding:12px 12px 70px}
            .header{padding:12px 16px}
            .header-logo img{height:28px}
            .header h1{font-size:.9em}
            .categories{grid-template-columns:repeat(2,1fr);gap:12px}
            .cat-card img{height:110px}
            .sub-grid{grid-template-columns:repeat(2,1fr);gap:12px}
            .msg{max-width:88%}
            .video-container{max-height:85vh}
            .welcome{padding:20px 16px;margin-bottom:16px}
            .welcome h2{font-size:1.3em}
            .pecas-info{padding:24px 16px}
            .pecas-info img{max-width:100%;height:200px}
            .registro-content{padding:24px 20px}
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-logo">
        <img src="https://www.storopack.com.br/fileadmin/_processed_/7/d/csm_Storopack_Logo_RGB_3c3cc237a9.jpg" alt="Storopack">
        <h1>Assistente T√©cnico<span>Suporte especializado</span></h1>
    </div>
    <div class="header-btns">
        <button class="hdr-btn" id="btnVoltar" onclick="voltar()">&#8592; Voltar</button>
        <button class="hdr-btn always" onclick="reiniciarSistema()" title="Reiniciar o sistema">&#8635;</button>
    </div>
</div>

<!-- MODAL DE REGISTRO -->
<div id="registroModal" class="registro-modal">
    <div class="registro-content">
        <h3>üìã Registro de Contato</h3>
        <p>Para melhor atend√™-lo, precisamos de algumas informa√ß√µes. Em caso de n√£o resolvermos o problema, um t√©cnico entrar√° em contato.</p>
        
        <label for="nomeCliente">Nome completo</label>
        <input type="text" id="nomeCliente" placeholder="Digite seu nome">
        
        <label for="telefoneCliente">Telefone com DDD</label>
        <input type="tel" id="telefoneCliente" placeholder="(11) 99999-9999">
        <div class="hint" id="telHint"></div>
        
        <button onclick="salvarRegistro()">Continuar</button>
        <p class="erro" id="registroErro">Por favor, preencha todos os campos</p>
    </div>
</div>

<div class="container">

    <!-- MENU PRINCIPAL -->
    <div id="telaMenu">
        <div class="welcome">
            <h2>üëã Ol√°! Em que posso ajudar?</h2>
            <p>Selecione a linha de equipamento para suporte t√©cnico especializado</p>
        </div>
        <div class="categories">
            <div class="cat-card" onclick="abrirCat('airplus')">
                <img src="https://www.bonustrading.co.uk/pub/media/catalog/product/cache/dc51ad1cee65ef039961365aac012b96/a/i/airplus-mini-machine-blue-film-600_1.jpg" alt="AIRplus">
                <div class="cat-card-body"><h3>AIRplus</h3><p>Travesseiros de ar</p></div>
            </div>
            <div class="cat-card" onclick="abrirCat('airmove')">
                <img src="https://www.storopack.com.br/fileadmin/_processed_/7/e/csm_PP_AP_AIRmove___machine_front_motive2_cushion_film_low_res_300dpi_061fd19c2b.jpg" alt="AIRmoves">
                <div class="cat-card-body"><h3>AIRmoves</h3><p>Linha compacta de ar</p></div>
            </div>
            <div class="cat-card" onclick="abrirCat('foamplus')">
                <img src="https://img.directindustry.com/pt/images_di/photo-g/34409-12098488.jpg" alt="FOAMplus">
                <div class="cat-card-body"><h3>FOAMplus</h3><p>Espuma expandida</p></div>
            </div>
            <div class="cat-card" onclick="abrirCat('paperplus')">
                <img src="https://www.storopack.com.br/fileadmin/_processed_/5/9/csm_PP_PP_Shooter_machine_tablestand_motive_1_1280x580px_c97e386ad4.png" alt="PAPERplus">
                <div class="cat-card-body"><h3>PAPERplus</h3><p>Papel amassado</p></div>
            </div>
        </div>
    </div>

    <!-- SUB: AIRplus -->
    <div id="sub_airplus" class="subcats">
        <div class="sub-hdr"><h3>üåÄ AIRplus - Selecione o modelo</h3></div>
        <div class="sub-grid">
            <div class="sub-card" onclick="abrirChat('airplus_mini','AIRplus Mini')">
                <img src="https://www.bonustrading.co.uk/pub/media/catalog/product/cache/dc51ad1cee65ef039961365aac012b96/a/i/airplus-mini-machine-blue-film-600_1.jpg" alt="AIRplus Mini">
                <h4>AIRplus Mini</h4>
                <p>Compacto</p>
            </div>
            <div class="sub-card" onclick="abrirChat('airplus_ergofeed','AIRplus Ergofeed')">
                <img src="https://www.storopack.com.br/fileadmin/_processed_/5/d/csm_PI_News_AP_Dispenser_Ergofeed_650x295px_7968352d06.png" alt="Ergofeed">
                <h4>Ergofeed</h4>
                <p>Dispenser ergon√¥mico</p>
            </div>
        </div>
    </div>

    <!-- SUB: AIRmoves -->
    <div id="sub_airmove" class="subcats">
        <div class="sub-hdr"><h3>üåÄ AIRmoves - Selecione o modelo</h3></div>
        <div class="sub-grid">
            <div class="sub-card" onclick="abrirChat('airmove_1','AIRmove 1')">
                <img src="https://www.storopack.com.br/fileadmin/_processed_/8/b/csm_PP_AP_AIRmove_machine_side_motive4_with_void_film_1280x580px_569007f63e.jpg" alt="AIRmove 1">
                <h4>AIRmove 1</h4>
                <p>Modelo lateral</p>
            </div>
            <div class="sub-card" onclick="abrirChat('airmove_2','AIRmove 2')">
                <img src="https://www.storopack.com.br/fileadmin/_processed_/7/e/csm_PP_AP_AIRmove___machine_front_motive2_cushion_film_low_res_300dpi_061fd19c2b.jpg" alt="AIRmove 2">
                <h4>AIRmove 2</h4>
                <p>Modelo frontal</p>
            </div>
        </div>
    </div>

    <!-- SUB: FOAMplus -->
    <div id="sub_foamplus" class="subcats">
        <div class="sub-hdr"><h3>üí® FOAMplus - Selecione o modelo</h3></div>
        <div class="sub-grid">
            <div class="sub-card" onclick="abrirChat('foam_bagpacker','FOAMplus Bag Packer')">
                <img src="https://img.directindustry.com/pt/images_di/photo-g/34409-12098488.jpg" alt="Bag Packer">
                <h4>Bag Packer</h4>
                <p>Sacos de espuma</p>
            </div>
            <div class="sub-card" onclick="abrirChat('foam_handpacker','FOAMplus Hand Packer')">
                <img src="https://5.imimg.com/data5/HS/KC/MW/SELLER-8794370/foamplus-hand-packer-2-machine.jpg" alt="Hand Packer">
                <h4>Hand Packer</h4>
                <p>Manual</p>
            </div>
        </div>
    </div>

    <!-- SUB: PAPERplus -->
    <div id="sub_paperplus" class="subcats">
        <div class="sub-hdr"><h3>üìÑ PAPERplus - Selecione o modelo</h3></div>
        <div class="sub-grid">
            <div class="sub-card" onclick="abrirChat('paper_shooter','PAPERplus Shooter')">
                <img src="https://www.storopack.com.br/fileadmin/_processed_/5/9/csm_PP_PP_Shooter_machine_tablestand_motive_1_1280x580px_c97e386ad4.png" alt="Shooter">
                <h4>Shooter</h4>
                <p>Mesa</p>
            </div>
            <div class="sub-card" onclick="abrirChat('paper_papillon','PAPERplus Papillon')">
                <img src="https://files.lbcdn.info/i/o/aHR0cHM6Ly93d3cuZ3JlZW5vc3VwcGx5LmNvbS9JbWFnZXMvR3JlZW5vdWdoJTIwUGljcy9QQVBFUnBsdXMlQzIlQUUlMjBQYXBpbGxvbiUyMFBhcGVyJTIwUGFja2FnaW5nJTIwU3lzdGVtLmpwZw2.jpg" alt="Papillon">
                <h4>Papillon</h4>
                <p>Sistema</p>
            </div>
            <div class="sub-card" onclick="abrirChat('paper_classic','PAPERplus Classic')">
                <img src="https://packair.ru/files/PACKAIR/photo/STOROPACK/PAPERplus/paperplus_classic.jpg" alt="Classic">
                <h4>Classic</h4>
                <p>Cl√°ssico</p>
            </div>
            <div class="sub-card" onclick="abrirChat('paper_cx','PAPERplus CX')">
                <img src="https://www.storopack.com.br/fileadmin/_processed_/1/e/csm_PP_PP_Classic_CX_machine_0539_1280x580px_EUROPEAN_STAND_756b4e2466.png" alt="CX">
                <h4>CX</h4>
                <p>Vers√£o CX</p>
            </div>
            <div class="sub-card" onclick="abrirChat('paper_track','PAPERplus Track')">
                <img src="https://bvs-verpacken.com/wp-content/uploads/2025/01/papierpolster-system-track-03.png" alt="Track">
                <h4>Track</h4>
                <p>Sistema Track</p>
            </div>
            <div class="sub-card" onclick="abrirChat('paper_chevron','PAPERplus Chevron')">
                <img src="https://www.storopack.com.br/fileadmin/_processed_/b/c/csm_PP_PP_Chevron___machine_floorstand_with_conveyor_motive2_1280x580px_900e25faea.png" alt="Chevron">
                <h4>Chevron</h4>
                <p>Com esteira</p>
            </div>
        </div>
    </div>

    <!-- PE√áAS INFO -->
    <div class="pecas-info" id="pecasInfo">
        <img src="https://www.storopack.com/fileadmin/_processed_/f/3/csm_PI_Packaging_Technical_Service_6584_640x590px_a4449a471c.jpg" alt="T√©cnico Storopack">
        <h3>üìû Precisa de pe√ßas?</h3>
        <p>Entre em contato com nossa equipe t√©cnica para solicitar pe√ßas de reposi√ß√£o originais Storopack. Nossa equipe est√° pronta para atender voc√™ com agilidade e qualidade.</p>
        <p style="margin-top:12px;color:#0056a3;font-weight:600">‚òéÔ∏è (11) 5677-4699 | ‚úâÔ∏è <a href="mailto:packaging.br@storopack.com">packaging.br@storopack.com</a></p>
    </div>

    <!-- CHAT -->
    <div id="telaChat" class="chat-box">
        <div id="chatInfo" class="chat-info"></div>
        <div id="chatMsgs" class="chat-msgs"></div>
        <div id="typing" class="typing">T√©cnico digitando</div>
        <div class="chat-input">
            <textarea id="chatIn" placeholder="Digite sua d√∫vida ou problema..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();enviar()}" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
            <input type="file" id="videoInput" accept="video/*" style="display:none" onchange="enviarVideo(this)">
            <button class="btn-att" onclick="document.getElementById('videoInput').click()" title="Enviar v√≠deo">üìπ</button>
            <button id="btnSend" class="btn-send" onclick="enviar()">Enviar</button>
        </div>
        <div id="fbBar" class="fb-bar">
            <p>‚úÖ Conseguimos resolver seu problema?</p>
            <div class="btns">
                <button class="b b-ok" onclick="enviarFb(true)">Sim, resolvido!</button>
                <button class="b b-no" onclick="enviarFb(false)">N√£o, preciso de ajuda</button>
            </div>
        </div>
    </div>

</div>

<!-- MODAL GPS -->
<div id="gpsOverlay" class="overlay">
    <div class="modal">
        <h3>üìç Localiza√ß√£o necess√°ria</h3>
        <p>Para oferecer um atendimento mais r√°pido e eficiente, precisamos da sua localiza√ß√£o para enviar um t√©cnico caso seja necess√°rio.</p>
        <div class="mg">
            <button class="btn bp" onclick="permitirGPS()">Permitir</button>
            <button class="btn bs" onclick="negarGPS()">Agora n√£o</button>
        </div>
    </div>
</div>

<!-- MODAL V√çDEO -->
<div id="videoModal" class="video-modal">
    <div class="video-container">
        <div class="video-header">
            <h3 id="videoTitle">Solu√ß√£o do problema</h3>
            <button class="video-close" onclick="fecharVideo()">√ó</button>
        </div>
        <div class="video-wrapper">
            <video id="videoPlayer" controls>
                <source id="videoSource" src="" type="video/mp4">
                Seu navegador n√£o suporta v√≠deo.
            </video>
            <div id="videoError" class="video-error" style="display:none">
                <p>‚ö†Ô∏è N√£o foi poss√≠vel carregar o v√≠deo</p>
                <p style="font-size:.9em">Verifique sua conex√£o</p>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
var sid='sess_'+Math.random().toString(36).substr(2,9);
var modAtual='',nomeAtual='',chamadoId=null,tela='menu';
var lat=null,lng=null;
var clienteNome='',clienteTelefone='';
var registroCompleto=false;

// V√çDEOS DE SOLU√á√ÉO DE ERROS
var videosErros={
    'E1':{titulo:'Erro E1 - Sensor de Temperatura',arquivo:'/static/erros/e1.mp4'},
    'E2':{titulo:'Erro E2 - Resist√™ncia de Selagem',arquivo:'/static/erros/e2.mp4'},
    'E3':{titulo:'Erro E3 - Sensor de Filme',arquivo:'/static/erros/e3.mp4'},
    'E4':{titulo:'Erro E4 - Posicionamento Inicial',arquivo:'/static/erros/e4.mp4'},
    'E5':{titulo:'Erro E5 - Motor de Passo',arquivo:'/static/erros/e5.mp4'},
    'E6':{titulo:'Erro E6 - Termopar',arquivo:'/static/erros/e6.mp4'},
    'E7':{titulo:'Erro E7 - Termopar',arquivo:'/static/erros/e7.mp4'},
    'E8':{titulo:'Erro E8 - Termopar',arquivo:'/static/erros/e8.mp4'},
    'E9':{titulo:'Erro E9 - Calibra√ß√£o Fora do Limite',arquivo:'/static/erros/e9.mp4'},
    'E10':{titulo:'Erro E10 - Par√¢metro Extremo',arquivo:'/static/erros/e10.mp4'},
    'E11':{titulo:'Erro E11 - Instabilidade na Selagem',arquivo:'/static/erros/e11.mp4'}
};

// DETECTAR TELEFONE AUTOMATICAMENTE
function detectarTelefone(){
    var tel=localStorage.getItem('telefone_cliente');
    if(tel){
        document.getElementById('telefoneCliente').value=tel;
        document.getElementById('telHint').innerHTML='‚úÖ N√∫mero detectado automaticamente. Pode alterar se necess√°rio.';
        document.getElementById('telHint').style.color='#28a745';
    }
}

// MOSTRAR MODAL DE REGISTRO
function mostrarRegistro(){
    document.getElementById('registroModal').classList.add('active');
    detectarTelefone();
    document.getElementById('nomeCliente').focus();
}

// SALVAR REGISTRO
function salvarRegistro(){
    var nome=document.getElementById('nomeCliente').value.trim();
    var tel=document.getElementById('telefoneCliente').value.trim();
    
    if(!nome || !tel){
        document.getElementById('registroErro').style.display='block';
        return;
    }
    
    // Validar telefone b√°sico
    var telLimpo=tel.replace(/\D/g,'');
    if(telLimpo.length<10){
        document.getElementById('registroErro').textContent='Telefone inv√°lido. Use (11) 99999-9999';
        document.getElementById('registroErro').style.display='block';
        return;
    }
    
    clienteNome=nome;
    clienteTelefone=tel;
    registroCompleto=true;
    
    // Salvar no localStorage
    localStorage.setItem('nome_cliente',nome);
    localStorage.setItem('telefone_cliente',tel);
    
    // Enviar ao backend
    fetch('/registrar-contato',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({nome:nome,telefone:tel,session_id:sid})
    });
    
    document.getElementById('registroModal').classList.remove('active');
    showToast('‚úÖ Registro salvo! Bem-vindo, '+nome.split(' ')[0]+'!');
}

// FORMATA√á√ÉO AUTOM√ÅTICA DE TELEFONE
document.getElementById('telefoneCliente').addEventListener('input',function(e){
    var v=e.target.value.replace(/\D/g,'');
    if(v.length<=11){
        v=v.replace(/^(\d{2})(\d)/g,'($1) $2');
        v=v.replace(/(\d)(\d{4})$/,'$1-$2');
        e.target.value=v;
    }
});

// GPS - Solicitar mas n√£o bloquear a interface
setTimeout(function(){
    if(!lat && !lng && tela==='menu'){
        document.getElementById('gpsOverlay').classList.add('active');
    }
},2000); // Reduzido de 3s para 2s

function permitirGPS(){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(p){
            lat=p.coords.latitude;lng=p.coords.longitude;
            document.getElementById('gpsOverlay').classList.remove('active');
            showToast('‚úÖ Localiza√ß√£o obtida com sucesso!');
            
            // Calcular dist√¢ncia da Storopack
            var dist=calcularDistancia(lat,lng,-23.645,-46.654);
            console.log('Dist√¢ncia da Storopack:',dist.toFixed(2),'km');
            
            // Mostrar se√ß√£o de pe√ßas ap√≥s obter localiza√ß√£o
            setTimeout(function(){
                if(tela==='menu'){
                    document.getElementById('pecasInfo').style.display='block';
                }
            },1000);
        },function(){
            document.getElementById('gpsOverlay').classList.remove('active');
            showToast('‚ö†Ô∏è N√£o foi poss√≠vel obter localiza√ß√£o');
        });
    }else{
        document.getElementById('gpsOverlay').classList.remove('active');
        showToast('‚ö†Ô∏è Navegador n√£o suporta geolocaliza√ß√£o');
    }
}

function negarGPS(){
    document.getElementById('gpsOverlay').classList.remove('active');
    showToast('‚ÑπÔ∏è Voc√™ pode permitir depois nas configura√ß√µes do navegador');
}

// CALCULAR DIST√ÇNCIA (HAVERSINE)
function calcularDistancia(lat1,lon1,lat2,lon2){
    var R=6371;
    var dLat=(lat2-lat1)*Math.PI/180;
    var dLon=(lon2-lon1)*Math.PI/180;
    var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
    var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
}

function showToast(msg){
    var t=document.getElementById('toast');
    t.textContent=msg;t.classList.add('active');
    setTimeout(function(){t.classList.remove('active')},3000);
}

// DETECTAR C√ìDIGO DE ERRO E BOT√ïES DE V√çDEO
function detectarErro(msg){
    var m=msg.toUpperCase();
    // Detectar padr√£o [SIM_VIDEO_EX]
    var matchBotao=m.match(/\[SIM_VIDEO_E(\d+)\]/);
    if(matchBotao){
        var numErro=matchBotao[1];
        return 'E'+numErro;
    }
    // Detectar erros E1-E11
    for(var i=1;i<=11;i++){
        var codigo='E'+i;
        if(m.includes(codigo))return codigo;
    }
    return null;
}

function criarBotoesVideo(texto){
    // Procurar padr√£o [SIM_VIDEO_EX] e substituir por bot√µes
    return texto.replace(/\[SIM_VIDEO_E(\d+)\]/gi,function(match,num){
        var codigo='E'+num;
        return '<div style="margin-top:10px"><button onclick="abrirVideo(\''+codigo+'\')" style="background:#0056a3;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;margin-right:8px">üìπ Sim, ver v√≠deo</button><button onclick="event.target.parentElement.style.display=\'none\'" style="background:#6c757d;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer">N√£o</button></div>';
    });
}

function abrirVideo(codigoErro){
    var video=videosErros[codigoErro];
    if(!video)return;
    var modal=document.getElementById('videoModal');
    var player=document.getElementById('videoPlayer');
    var source=document.getElementById('videoSource');
    var titulo=document.getElementById('videoTitle');
    var erro=document.getElementById('videoError');
    titulo.textContent=video.titulo;
    source.src=video.arquivo;
    player.load();
    modal.classList.add('active');
    erro.style.display='none';
    player.play().catch(function(e){console.error('Erro ao reproduzir:',e)});
    player.onerror=function(){erro.style.display='block'};
}

function fecharVideo(){
    var modal=document.getElementById('videoModal');
    var player=document.getElementById('videoPlayer');
    player.pause();
    player.currentTime=0;
    modal.classList.remove('active');
}

document.addEventListener('keydown',function(e){
    if(e.key==='Escape')fecharVideo();
});

// NAV
function abrirCat(c){
    document.getElementById('telaMenu').style.display='none';
    document.querySelectorAll('.subcats').forEach(function(e){e.classList.remove('active')});
    document.getElementById('sub_'+c).classList.add('active');
    document.getElementById('btnVoltar').style.display='inline-block';
    tela='sub';
}

function abrirChat(mod,nome){
    // Verificar registro antes de abrir chat
    if(!registroCompleto){
        mostrarRegistro();
        // Aguardar registro e tentar novamente
        setTimeout(function(){
            if(registroCompleto){
                iniciarChat(mod,nome);
            }
        },500);
        return;
    }
    iniciarChat(mod,nome);
}

function iniciarChat(mod,nome){
    modAtual=mod;nomeAtual=nome;chamadoId=null;
    document.querySelectorAll('.subcats').forEach(function(e){e.classList.remove('active')});
    document.getElementById('telaMenu').style.display='none';
    document.getElementById('telaChat').classList.add('active');
    document.getElementById('chatInfo').textContent='üí¨ '+nome;
    document.getElementById('btnVoltar').style.display='inline-block';
    tela='chat';
    document.getElementById('chatMsgs').innerHTML='';
    addMsg('bot','Ol√° '+clienteNome.split(' ')[0]+'! üëã\n\nSou o assistente t√©cnico da Storopack para '+nome+'.\n\nComo posso te ajudar hoje?');
    document.getElementById('chatIn').focus();
}

function voltar(){
    if(tela==='chat'){
        if(chamadoId){document.getElementById('fbBar').classList.add('active');return}
        fecharChat();
    }else if(tela==='sub'){
        document.querySelectorAll('.subcats').forEach(function(e){e.classList.remove('active')});
        document.getElementById('telaMenu').style.display='block';
        document.getElementById('btnVoltar').style.display='none';
        tela='menu';
    }
}

function fecharChat(){
    document.getElementById('telaChat').classList.remove('active');
    document.getElementById('fbBar').classList.remove('active');
    document.querySelectorAll('.subcats').forEach(function(e){e.classList.remove('active')});
    document.getElementById('telaMenu').style.display='block';
    document.getElementById('btnVoltar').style.display='none';
    tela='menu';chamadoId=null;
}

// CHAT
function addMsg(tipo,txt){
    var d=document.createElement('div');
    d.className='msg '+tipo;
    var h=new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    
    // Processar bot√µes de v√≠deo se for mensagem do bot
    var conteudo=txt;
    if(tipo==='bot'){
        conteudo=criarBotoesVideo(txt);
    }
    
    d.innerHTML=conteudo+'<span class="tm">'+h+'</span>';
    document.getElementById('chatMsgs').appendChild(d);
    document.getElementById('chatMsgs').scrollTop=99999;
}

function enviar(){
    var inp=document.getElementById('chatIn');
    var m=inp.value.trim();
    if(!m)return;
    inp.value='';inp.style.height='auto';
    addMsg('user',m);
    document.getElementById('typing').classList.add('active');
    document.getElementById('btnSend').disabled=true;
    
    fetch('/chat',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            mensagem:m,
            modulo:modAtual,
            session_id:sid,
            chamado_id:chamadoId,
            latitude:lat,
            longitude:lng,
            nome_cliente:clienteNome,
            telefone_cliente:clienteTelefone
        })
    })
    .then(function(r){return r.json()})
    .then(function(d){
        chamadoId=d.chamado_id||chamadoId;
        addMsg('bot',d.resposta);
    })
    .catch(function(){addMsg('bot','‚ö†Ô∏è Erro de conex√£o. Tente novamente.')})
    .finally(function(){
        document.getElementById('typing').classList.remove('active');
        document.getElementById('btnSend').disabled=false;
        inp.focus();
    });
}

function enviarVideo(inp){
    var f=inp.files[0];if(!f)return;
    if(f.size>100*1024*1024){showToast('‚ö†Ô∏è V√≠deo muito grande (m√°x 100MB)');return}
    addMsg('user','üìπ Enviando v√≠deo para an√°lise...');
    document.getElementById('typing').classList.add('active');
    var fd=new FormData();
    fd.append('video',f);
    fd.append('modulo',modAtual);
    fd.append('chamado_id',chamadoId||'');
    fd.append('session_id',sid);
    fd.append('nome_cliente',clienteNome);
    fd.append('telefone_cliente',clienteTelefone);
    
    fetch('/analyze-video',{method:'POST',body:fd})
    .then(function(r){return r.json()})
    .then(function(d){
        chamadoId=d.chamado_id||chamadoId;
        addMsg('bot',d.resposta);
    })
    .catch(function(){addMsg('bot','‚ö†Ô∏è Erro ao enviar v√≠deo.')});
    
    document.getElementById('typing').classList.remove('active');
    inp.value='';
}

function enviarFb(ok){
    fetch('/feedback',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            chamado_id:chamadoId,
            resolvido:ok,
            comentario:ok?'Resolvido':'N√£o resolvido'
        })
    });
    showToast(ok?'‚úÖ Que bom! Ficamos felizes em ajudar!':'üìû Nosso t√©cnico entrar√° em contato em breve!');
    setTimeout(fecharChat,1500);
}

// REINICIAR
function reiniciarSistema(){
    if(!confirm('üîÑ Reiniciar o sistema? O app ser√° recarregado.'))return;
    showToast('üîÑ Reiniciando...');
    localStorage.clear();
    fetch('/reiniciar',{method:'POST'}).catch(function(){});
    setTimeout(function(){location.reload()},1000);
}

// CARREGAR DADOS SALVOS
window.onload=function(){
    var nomeSalvo=localStorage.getItem('nome_cliente');
    var telSalvo=localStorage.getItem('telefone_cliente');
    if(nomeSalvo && telSalvo){
        clienteNome=nomeSalvo;
        clienteTelefone=telSalvo;
        registroCompleto=true;
    }
};
</script>
</body>
</html>
